### Содержание

* [Введение](#introduction)

<a name="introduction"></a>
#### Введение

vUpdate выполняет создание версий, мониторинг работы и обновление сервисов.

#### Сервисы

Сервисом может считаться целое приложение, или его часть.
У сервиса есть каталоги исходных кодов в репозитории Git.
С этих каталогов, по определённым правилам, собирается версия сервиса.

Жизненный цикл сервиса состоит из следующих этапов:
* Создание версии сервиса
* Создание пользовательской версии сервиса с кастомизацией настроек для конкретного клиента
* Установка/обновление инстанций серверных приложений
* Запись журналов работы сервиса в базу данных
* Запись отчётов о сбоях сервиса в базу данных

#### Сервисы vUpdate

vUpdate сам состоит из сервисов. Таким образом, vUpdate обновляет сам себя.

* distribution - Сервер дистрибуции
  * Backend
    * Web Server (платформа [Scala Akka HTTP](https://doc.akka.io/docs/akka-http/current/index.html)) 
      * Поддерживает запросы GraphQL (платформа [Sangria GraphQL](https://github.com/sangria-graphql/sangria))
        * Генерации новых версий сервисов
        * Установки и поиска
          * настроек и аккаунтов
          * версий сервисов
          * журналов сервисов
          * отчётов о сбоях сервисов
    * База данных [MongoDB](https://github.com/mongodb/mongo)
  * Frontend (платформа [React Js](https://reactjs.org)
    * Администрирование vUpdate
    * Создание новых версий
    * Просмотр журналов сервисов
    * Просмотр отчётов о сбоях
* builder - Генератор версий (Scala command line application)
* updater - Установщик инстанции сервисов (Scala command line application)
  * Установка сервисов
  * Запуск инстанций сервисов
  * Отправка журналов работы сервисов на сервер дистрибуции
  * Отправка отчёта о сбое на сервер дистрибуции при неожиданном завершении сервиса
  * Обновление и перезапуск сервиса при обновлении версии на сервере дистрибуции
  * Хранение на сервере истории журналов последних работавших инстанций сервисов
* scripts - Скрипты начальной установки и обновления сервисов (Shell, YAML)

### Дистрибуция сервисов

Разработчик создаёт на сервере дистрибуции версию сервиса, в которую входят:
* выполнимые файлы
* скрипты с макрорасширениями
* правила создания клиентской версии, установки и обновления

Версия сервиса от разработчика имеет формат _distribution-build_:
- _distribution_ - имя сервера дистрибуции, на котором создана версия.
- _build_ - номер сборки из чисел, разделённых точками, например *4.21.2*.

Таким образом, для сервера дистрибуции _jetto_ и сборки _3.5.1_, будет версия _jetto-3.5.1_.

Из версии разработчика создаётся клиентская версия на том сервере дистрибуции, где она будет использоваться. 
Клиентская версия содержит кастомизацию обшей версии под конкретного клиента.
Она может уточнять конкретные настройки, задавать ключи, сертификаты, и т.д.

Начальная клиентская версия имеет тоже название, что и версия разработчика, с которой она была создана.
Если настройки клиента поменялись, клиентская версия пересоздаётся заново. Новая версия будет иметь окончание ._N, где N - номер генерации клиентской версии.
Например, созданная с версии разработчика _jetto-3.5.1_ клиентская версия будет называться _jetto-3.5.1_, следующие сборки будут называться _jetto-3.5.1_1_, _jetto-3.5.1_2_, ... 


##### Provider/Consumer


Сервера дистрибуции могут объединяться в сеть по принципу Provider/Consumer.

Provider предоставляет для Consumer заданные в profile сервисы.
Consumer всегда может проверить, не появились ли на Provider новые версии, скачать и установить их у себя. 

При возникновении сбоя полученной версии сервиса Consumer отправляет отчёт о сбое Provider-у.

Provider также может выполнять для Consumer Builder. Это необходимо, если на сервер Consumer нет достаточных ресурсов для сборки версии.

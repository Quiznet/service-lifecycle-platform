# Введение

vUpdate выполняет создание версий, мониторинг работы и обновление сервисов.
В настоящее время vUpdate работает на серверах Linux Ubuntu.

## Сервисы

Сервисом может считаться целое приложение, или его часть.
У сервиса есть каталоги исходных кодов в репозитории Git.
С этих каталогов, по определённым правилам, собирается версия сервиса.

### Жизненный цикл сервиса
- Создание разработческой версии сервиса
- Создание клиентской версии сервиса с кастомизацией настроек для конкретного клиента
- Установка/обновление инстанций серверных приложений
- Запись журналов работы сервиса в базу данных
- Запись отчётов о сбоях сервиса в базу данных

### Версии сервисов

Разработчик создаёт на сервере дистрибуции версию сервиса, в которую входят:
- выполнимые файлы
- скрипты с макрорасширениями
- правила создания клиентской версии, установки и обновления

Версия сервиса от разработчика имеет формат _distribution-build_:
- _distribution_ - имя сервера дистрибуции, на котором создана версия.
- _build_ - номер сборки из чисел, разделённых точками, например *4.21.2*.

Таким образом, для сервера дистрибуции _jetto_ и сборки _3.5.1_, 
будет версия _jetto-3.5.1_.

Из версии разработчика создаётся клиентская версия на том сервере дистрибуции, 
где она будет использоваться. 
Клиентская версия содержит кастомизацию обшей версии под конкретного клиента.
Она может уточнять конкретные настройки, задавать ключи, сертификаты, и т.д.

Начальная клиентская версия имеет тоже название, что и версия разработчика, 
с которой она была создана.
Если настройки клиента поменялись, клиентская версия пересоздаётся заново. 
Новая версия будет иметь окончание ._N, где N - номер генерации клиентской версии.
Например, созданная с версии разработчика _jetto-3.5.1_, клиентская версия будет называться _jetto-3.5.1_, 
следующие сборки будут называться _jetto-3.5.1_1_, _jetto-3.5.1_2_, ...

### Желательные версии (Desired Versions)

Сервер дистрибуции хранит некоторое количество последних сгенерированных версий сервиса.
Для того, чтобы указать, какую именно версию использовать в текущий момент, предназначен список желательных версий
в формате _сервис-версия_.
Есть список желательных девелоперских версий и клиентских версий.


По умолчанию, при генерации новой версии, номер новой версии становится желательным для данного сервиса.
Номер желательной версии можно изенить вручную. 

## Сервисы vUpdate

vUpdate сам состоит из сервисов. Таким образом, vUpdate обновляет сам себя.
Сервисы vUpdate:

- distribution - Сервер дистрибуции
  - Backend
    - Distribution Web Server (платформа [Scala Akka HTTP](https://doc.akka.io/docs/akka-http/current/index.html))
      - Поддерживает запросы GraphQL (платформа [Sangria GraphQL](https://github.com/sangria-graphql/sangria))
    - База данных [MongoDB](https://github.com/mongodb/mongo)
  - Frontend 
    - Distribution Dashboard (платформа [React Js](https://reactjs.org)
- builder - Генератор версий (Scala command line application)
- updater - Установщик инстанции сервисов (Scala command line application)
- scripts - Скрипты начальной установки и обновления сервисов (Shell, YAML)


### Взаимодействие сервисов vUpdate

Ключевым компонентом vUpdate является сервер дистрибуции, с управлением через Web-интерфейс. 
На сервере дистрибуции создаются новые версии сервисов. Для создания новой версии, 
_distribution_ запускает _builder_.  

Клиентские версии сервисов скачиваются, устанавливаются и запускаются _updater_-ом.
_Updater_ отправляет журналы работы сервиса на сервер дистрибуции.

Если сервис неожиданно завершается, _updater_ отправляет на сервер дистрибуции отчёт о сбое.
В отчёте содержится:
  - общая информация
  - последние журналы
  - специфические файлы с информацией о сбое, такие, как core dump, или Java hprof 

Если на сервере дистрибуции меняется желательная версия сервиса, _updater_ скачивает новую версию, 
останавливает старую версию, и запускает новую.

## Объединение в сеть серверов дистрибуции

Сервера дистрибуции могут объединяться в сеть по принципу _provider/consumer_.

_Provider_ предоставляет для _consumer_ заданные в его profile сервисы.
Если на _provider_ появились новые версии, _consumer_ может скачать их, и установить у себя.
Таким образом компания, разрабатывающая сервисы, может завести учётную запись _consumer_ 
клиента на своём сервере дистрибуции и определить список сервисов, которые она хочет отдавать этому клиенту.

_Consumer_ отправляет _provider_-у:
  - Информацию об установленных версиях сервисов _provider_-а.
  - Отчёты о сбоях сервисов

_Provider_ также может выполнять _builder_ для _consumer_. 
Это необходимо, если на сервере _consumer_ нет достаточных ресурсов для сборки версии.

### Предварительное тестирование 

Перед установкой сервисов на рабочие сервера, желательно провести комплексное тестирование.
Для того, чтобы сервисы могли ставиться на рабочие сервера только после того, как они будут
протестированы, vUpdate имеет механим пометки списка версий сервисов, как протестированных.

Например, есть некий сервер дистрибуции для рабочих серверов с именем _production_, в конфигурации которого задан
тестовый сервер дистрибуции _test_. Установка новых версий сервисов на сервер _production_
произойдёт только в случае, если они были протестированы на _test_, и помечены _test_-ом, 
как протестированные.

# Установка и настройка

## Создание сервера дистрибуции

Сервер дистрибуции может быть собран и установлен с исходных кодов, 
или с другого сервера дистрибуции.

## Сборка и установка сервера дистрибуции с исходных кодов

Установите базу данных MongoDB.

Клонируйте репозиторий vUpdate на сервер дистрибуции:

`git clone git@github.com:jorkey/vUpdate.git`

Выполните команду:

`sbt "project builder; run buildProviderDistribution cloudProvider=? distribution=? directory=? port=? title=? mongoDbName=? serviceOS=?"`

Вместо `?` подставьте значения:
- _cloudProvider_ (необязательно)
  - тип облачного сервиса, если сервер дистрибуции находится в облаке:
      - Azure - единственное на данный момент поддерживаемое облако
- _distribution_
  - уникальное имя сервера дистрибуции, без пробелов
- _directory_
  - каталог для установки
- _port_
  - порт для сервиса http (сервис https можно определить позднее в настройках)
- _title_
  - короткое описание сервера дистрибуции
- _mongoDbName_
  - имя базы данных MongoDB
- _serviceOS_ (необязательно)
  - в настоящее время только для установки на Linux. 
  - true, если сервер дистрибуции устанавливается как сервис systemd Linux. 

После завершения команды должен запуститься процесс сервера дострибуции.

## Установка сервера дистрибуции с другого сервера дистрибуции

Заведите учётную запись для нового _customer_ на исходном сервере дистрибуции (см [Учётные записи сервисов](#services_accounts)).

Установите базу данных MongoDB.

Скопируйте во временный каталог из каталога исходного сервера дистрибуции файл _.update.sh_.
Создайте там же скрипт _clone_distribution.sh_:

```
#!/bin/bash -e
set -e

serviceToRun=builder

distributionUrl=?
accessToken=?

. .update.sh "$@" buildConsumerDistribution providerUrl=$distributionUrl cloudProvider=? distribution=? directory=? port=? title=? mongoDbName=? provider=? consumerAccessToken=? testConsumerMatch=? serviceOS=? 
```

Вместо `?` подставьте значения:
- _distributionUrl_
  - URL исходного сервера дистрибуции
- _accessToken_
  - Access Token сервиса _builder_ исходного сервера дистрибуции
    - Зайдите в _Settings/Accounts/Services_ и нажмите на значок ключа для _builder_.  
- _cloudProvider_ (необязательно)
  - тип облачного сервиса, если сервер дистрибуции находится в облаке:
    - Azure - единственное на данный момент поддерживаемое облако
- _distribution_
  - уникальное имя сервера дистрибуции
- _directory_
  - каталог для установки
- _port_
  - порт для сервиса http (сервис https можно определить позднее в настройках)
- _title_
  - короткое описание сервера дистрибуции
- _mongoDbName_
  - имя базы данных MongoDB
- _provider_
  - имя исходного сервера дистрибуции
- _consumerAccessToken_
  - Access Token для учётной записи _consumer_
    - Зайдите в _Settings/Accounts/Distribution Consumers_ и нажмите на значок ключа для соответствующей записи.
- _testConsumerMatch_
  - имя сервера дистрибуции тестовой системы
- _serviceOS_ (необязательно)
  - в настоящее время только для установки на Linux.
  - true, если сервер дистрибуции устанавливается как сервис systemd Linux.

Выполните скрипт _clone_distribution.sh_. 
После завершения скрипта должен запуститься процесс сервера дострибуции.

## Настройка сервера дистрибуции

### Конфигурационный файл 

Файл конфигурации _distribution.json_ находится в рабочем каталоге сервера дистрибуции и имеет следующий формат:

- _distribution_ - уникальное имя сервера дистрибуции
- _title_ - заголовок сервера дистрибуции
- _instance_ - идентификатор инстанции виртуальной мащины 
- _jwtSecret_ - ключ кодирования JWT
- _mongoDb_ - настройка подключения к Mongo DB
  - _connection_ - URL подключения 
  - _name_ - имя базы
- _network_
  - _port_ - номер серверного порта http или https
  - _ssl_ (необязательно, для сервиса https)
    - _keyStoreFile_ - файл jks с ключами и сертификатами
    - _keyStorePassword_ - пароль доступа к key store
- _builder_ - запуск _builder_
  - _distribution_ - имя сервера дистрибуции, на котором запускать _builder_
- _versions_ - история версий
  - maxHistorySize - максимальное количество версий сервиса в истории
- serviceStates - состояние сервисов 
  - expirationTimeout - длительность хранения в базе последнего состояния сервиса. Если в течение этого времени состояние не обновляется, инстанция сервиса считается умершей.
- logs - журналы сервисов
  - expirationTimeout - длительность хранения в базе записи в журнал
- faultReports - отчёты о сбоях
  - expirationTimeout - длительность хранения в базе записи отчёта о сбое
  - maxReportsCount - максимальное число отчётов о сбоях в базе

### Настройки в Distribution Frontend

Откройте ссылку на сервер дистрибуции в бравсере. 
Введите Account Name: admin и Password: admin.
Вы зашли в систему, как администратор. 

Смените начальный пароль. Для этого войдите в _Settings/Accounts/Users_, выберите пользователя _admin_,
и нажмите "Change Password".

#### Учётные записи

Администрируются в _Settings/Accounts_.

##### Пользователи

Заведите пользователей Dashboard, разработчиков и администраторов.
В информации о верси сервиса будет отображаться имя создавшего его пользователя. 

<a name="services_accounts"></a>
##### Сервисы

Учётные записи сервисов vUpdate. После установки сервера дистрибуции уже присутствуют 
записи _builder_ и _updater_.
Нажав на иконку с ключом, можно полусить Access Key для данного сервиса.
Access Key используется в скриптах запуска и обновления сервисов.

##### Distribution Consumers  

Учётные записи других серверов дистрибуции. 
В учётной записи, помимо прочего, указываются: 
- URL сервера дистрибуции. Его использует _builder_ для удалённой сборки сервиса.
- Services Profile - список разрабатываемых сервисов, которые поставляются данному серверу дистрибуции.

#### Настройка сервисов

##### Development

Описание сервисов для разработки. 
Для каждого сервиса указываются источники исходных кодов:
- URL - доступ к Git репозиторию  
- Branch - branch Git репозитория
- Clone Submodules - скачивать вместе с подмодулями

##### Service Profiles

Для определения, как раздавать разрабатываемые сервисы, 
назначаются именованные группы сервисов, именуемые профилями.
Таким образом, профиль является подмножеством списка сервисов для разработки.
Профиль назначается _distribution consumer_ в настройках.
Для обозначения разрабатываемых сервисов, для которых также создаются клиентские версии
на данном сервере дистрибуции, определяется профиль _self_.

#### Providers

Здесь определяются _distribution providers_ данного сервера дистрибуции.
Среди прочего, для _distribution provider_ определяются:
- _Access Token_ - ключ доступа при запросах к серверу
- _Test Consumer_ - имя _consumer distribution_, после тестирования которым, сервисы могут быть установлены на данном сервере
- _Upload State Interval_ - интервал загрузки состояния на _distribution provider_   

# Подготовка репозитория разработки




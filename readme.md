<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**Table of Contents**  *generated with [DocToc](https://github.com/thlorenz/doctoc)*

- [Введение](#%D0%B2%D0%B2%D0%B5%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5)
  - [Требуемые платформы](#%D1%82%D1%80%D0%B5%D0%B1%D1%83%D0%B5%D0%BC%D1%8B%D0%B5-%D0%BF%D0%BB%D0%B0%D1%82%D1%84%D0%BE%D1%80%D0%BC%D1%8B)
  - [Соглашения к оформлению](#%D1%81%D0%BE%D0%B3%D0%BB%D0%B0%D1%88%D0%B5%D0%BD%D0%B8%D1%8F-%D0%BA-%D0%BE%D1%84%D0%BE%D1%80%D0%BC%D0%BB%D0%B5%D0%BD%D0%B8%D1%8E)
  - [Сервисы](#%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B)
    - [Жизненный цикл сервиса](#%D0%B6%D0%B8%D0%B7%D0%BD%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9-%D1%86%D0%B8%D0%BA%D0%BB-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0)
    - [Профили сервисов](#%D0%BF%D1%80%D0%BE%D1%84%D0%B8%D0%BB%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
    - [Роль сервиса](#%D1%80%D0%BE%D0%BB%D1%8C-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0)
  - [Версии сервисов](#%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
    - [Версия разработчика](#%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D1%8F-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B0)
    - [Клиентская версия](#%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%81%D0%BA%D0%B0%D1%8F-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D1%8F)
    - [Желательные версии (desired versions)](#%D0%B6%D0%B5%D0%BB%D0%B0%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D1%8B%D0%B5-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8-desired-versions)
- [Настройки сервисов](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
  - [Настройки обновления и запуска сервисов](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D1%8F-%D0%B8-%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
  - [Настройки работы сервиса от разработчика](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0-%D0%BE%D1%82-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B0)
  - [Кастомизация настроек для клиента](#%D0%BA%D0%B0%D1%81%D1%82%D0%BE%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BA-%D0%B4%D0%BB%D1%8F-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D0%B0)
- [Сервисы vUpdate](#%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B-vupdate)
  - [Scripts](#scripts)
  - [Distribution Server](#distribution-server)
    - [Создание сервера дистрибуции](#%D1%81%D0%BE%D0%B7%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
      - [Сборка и установка сервера дистрибуции с исходных кодов](#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B8-%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8-%D1%81-%D0%B8%D1%81%D1%85%D0%BE%D0%B4%D0%BD%D1%8B%D1%85-%D0%BA%D0%BE%D0%B4%D0%BE%D0%B2)
      - [Установка сервера дистрибуции с другого сервера дистрибуции](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8-%D1%81-%D0%B4%D1%80%D1%83%D0%B3%D0%BE%D0%B3%D0%BE-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
    - [Настройка сервера дистрибуции](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
      - [Конфигурационный файл](#%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D0%B9-%D1%84%D0%B0%D0%B9%D0%BB)
    - [Работа сервера дистрибуции](#%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
      - [Запросы GraphQL](#%D0%B7%D0%B0%D0%BF%D1%80%D0%BE%D1%81%D1%8B-graphql)
      - [Запись журналов](#%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C-%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%BE%D0%B2)
      - [Задачи](#%D0%B7%D0%B0%D0%B4%D0%B0%D1%87%D0%B8)
      - [Обработка состояния сервисов](#%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0-%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
      - [Обработка отчётов о сбоях](#%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0-%D0%BE%D1%82%D1%87%D1%91%D1%82%D0%BE%D0%B2-%D0%BE-%D1%81%D0%B1%D0%BE%D1%8F%D1%85)
      - [Взаимодействие с другими серверами дистрибуции](#%D0%B2%D0%B7%D0%B0%D0%B8%D0%BC%D0%BE%D0%B4%D0%B5%D0%B9%D1%81%D1%82%D0%B2%D0%B8%D0%B5-%D1%81-%D0%B4%D1%80%D1%83%D0%B3%D0%B8%D0%BC%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0%D0%BC%D0%B8-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
    - [Обновление сервера дистрибуции](#%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
    - [История документов в Mongo DB](#%D0%B8%D1%81%D1%82%D0%BE%D1%80%D0%B8%D1%8F-%D0%B4%D0%BE%D0%BA%D1%83%D0%BC%D0%B5%D0%BD%D1%82%D0%BE%D0%B2-%D0%B2-mongo-db)
  - [Builder](#builder)
    - [Установка и обновление](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%B8-%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5)
    - [Установка сервера дистрибуции](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0-%D0%B4%D0%B8%D1%81%D1%82%D1%80%D0%B8%D0%B1%D1%83%D1%86%D0%B8%D0%B8)
    - [Сборка версии разработчика](#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B0)
    - [Сборка клиентской версии](#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%81%D0%BA%D0%BE%D0%B9-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8)
  - [Updater](#updater)
    - [Установка updater](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-updater)
    - [Файл конфигурации updater.json](#%D1%84%D0%B0%D0%B9%D0%BB-%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%B8-updaterjson)
    - [Запуск updater](#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-updater)
    - [Работа updater](#%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0-updater)
      - [Установка сервиса](#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0)
      - [Запуск сервиса](#%D0%B7%D0%B0%D0%BF%D1%83%D1%81%D0%BA-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0)
      - [Запись журнала работы](#%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C-%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%B0-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B)
      - [Отправка состояния сервисов](#%D0%BE%D1%82%D0%BF%D1%80%D0%B0%D0%B2%D0%BA%D0%B0-%D1%81%D0%BE%D1%81%D1%82%D0%BE%D1%8F%D0%BD%D0%B8%D1%8F-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
      - [Обработка сбоя сервисов](#%D0%BE%D0%B1%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B0-%D1%81%D0%B1%D0%BE%D1%8F-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
      - [Аварийное прерывание работы сервиса _updater_-ом](#%D0%B0%D0%B2%D0%B0%D1%80%D0%B8%D0%B9%D0%BD%D0%BE%D0%B5-%D0%BF%D1%80%D0%B5%D1%80%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%8B-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0-_updater_-%D0%BE%D0%BC)
      - [Обновление версии](#%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8)
    - [Самообновление](#%D1%81%D0%B0%D0%BC%D0%BE%D0%BE%D0%B1%D0%BD%D0%BE%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5)
- [Distribution Dashboard](#distribution-dashboard)
      - [Настройки](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8)
        - [Учётные записи](#%D1%83%D1%87%D1%91%D1%82%D0%BD%D1%8B%D0%B5-%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D0%B8)
          - [Пользователи](#%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B8)
          - [Сервисы](#%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D1%8B-1)
          - [Distribution Consumers](#distribution-consumers)
        - [Настройка сервисов](#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%BE%D0%B2)
          - [Development](#development)
          - [Service Profiles](#service-profiles)
        - [Providers](#providers)
  - [Сборка версии разработчика](#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8-%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D1%87%D0%B8%D0%BA%D0%B0-1)
  - [Сборка клиентских версий](#%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B0-%D0%BA%D0%BB%D0%B8%D0%B5%D0%BD%D1%82%D1%81%D0%BA%D0%B8%D1%85-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B9)
    - [С закачкой от поставщика](#%D1%81-%D0%B7%D0%B0%D0%BA%D0%B0%D1%87%D0%BA%D0%BE%D0%B9-%D0%BE%D1%82-%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D1%89%D0%B8%D0%BA%D0%B0)
    - [Без закачки от поставщика](#%D0%B1%D0%B5%D0%B7-%D0%B7%D0%B0%D0%BA%D0%B0%D1%87%D0%BA%D0%B8-%D0%BE%D1%82-%D0%BF%D0%BE%D1%81%D1%82%D0%B0%D0%B2%D1%89%D0%B8%D0%BA%D0%B0)
    - [Мониторинг процесса сборки](#%D0%BC%D0%BE%D0%BD%D0%B8%D1%82%D0%BE%D1%80%D0%B8%D0%BD%D0%B3-%D0%BF%D1%80%D0%BE%D1%86%D0%B5%D1%81%D1%81%D0%B0-%D1%81%D0%B1%D0%BE%D1%80%D0%BA%D0%B8)
    - [Пометка версий как протестированных](#%D0%BF%D0%BE%D0%BC%D0%B5%D1%82%D0%BA%D0%B0-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B9-%D0%BA%D0%B0%D0%BA-%D0%BF%D1%80%D0%BE%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D1%85)
  - [Желаемые версии](#%D0%B6%D0%B5%D0%BB%D0%B0%D0%B5%D0%BC%D1%8B%D0%B5-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B8)
    - [Откат до предыдущей редакции списка](#%D0%BE%D1%82%D0%BA%D0%B0%D1%82-%D0%B4%D0%BE-%D0%BF%D1%80%D0%B5%D0%B4%D1%8B%D0%B4%D1%83%D1%89%D0%B5%D0%B9-%D1%80%D0%B5%D0%B4%D0%B0%D0%BA%D1%86%D0%B8%D0%B8-%D1%81%D0%BF%D0%B8%D1%81%D0%BA%D0%B0)
    - [Назначение версий вручную](#%D0%BD%D0%B0%D0%B7%D0%BD%D0%B0%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B2%D0%B5%D1%80%D1%81%D0%B8%D0%B9-%D0%B2%D1%80%D1%83%D1%87%D0%BD%D1%83%D1%8E)
  - [Наблюдение за журналами](#%D0%BD%D0%B0%D0%B1%D0%BB%D1%8E%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0-%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%B0%D0%BC%D0%B8)
    - [Наблюдение за журналами задач](#%D0%BD%D0%B0%D0%B1%D0%BB%D1%8E%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0-%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%B0%D0%BC%D0%B8-%D0%B7%D0%B0%D0%B4%D0%B0%D1%87)
    - [Наблюдение за журналами сервиса](#%D0%BD%D0%B0%D0%B1%D0%BB%D1%8E%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0-%D0%B6%D1%83%D1%80%D0%BD%D0%B0%D0%BB%D0%B0%D0%BC%D0%B8-%D1%81%D0%B5%D1%80%D0%B2%D0%B8%D1%81%D0%B0)
  - [Наблюдение за отчётами о сбоях](#%D0%BD%D0%B0%D0%B1%D0%BB%D1%8E%D0%B4%D0%B5%D0%BD%D0%B8%D0%B5-%D0%B7%D0%B0-%D0%BE%D1%82%D1%87%D1%91%D1%82%D0%B0%D0%BC%D0%B8-%D0%BE-%D1%81%D0%B1%D0%BE%D1%8F%D1%85)
  - [Dashboard](#dashboard)
    - [Панель Versions](#%D0%BF%D0%B0%D0%BD%D0%B5%D0%BB%D1%8C-versions)
    - [Панель Last Developer Versions](#%D0%BF%D0%B0%D0%BD%D0%B5%D0%BB%D1%8C-last-developer-versions)
    - [Панель Last Client Versions](#%D0%BF%D0%B0%D0%BD%D0%B5%D0%BB%D1%8C-last-client-versions)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

<a name="services_accounts"></a>
# Введение

vUpdate выполняет создание версий, обновление, запуск и мониторинг работы сервисов.
Хранение истории позволяет откатывать изменения назад. Централизованное хранение журналов работы
и отчётов о сбоях удобно для мониторинга работы системы и оперативного устранения ошибок.

## Требуемые платформы

В настоящее время vUpdate работает на серверах Linux Ubuntu.
Исходные коды должны находиться в репозиториях Git VCS.
Поддерживается работа с облачным сервисом Microsoft Azure.

## Соглашения к оформлению

Для отображения структуры файлов _Json_ принято следующее.

Пара имя/значение:
- _name_ : строка
- _name:number_ : число
- _name:boolean_ : булевское

Объект
- _name_
  - содержимое объекта

Массив
- _name[]_ - массив строк
- _name:number[]_ - массив чисел
- _name[]_ - массив объектов
  - ... - содержимое объекта
  
Необязательное значение:
- `name`

## Сервисы

Сервисом может считаться целое приложение, или его часть. 
Например, сервисом может быть выполнимый файл с набором разделяемых библиотек, 
или только разделяемые библиотеки.
Для сервиса описываются правила сборки версии и установки.
Если сервис является выполнимой программой, для него также описываются правила запуска, 
записи журналов и отчётов о сбоях.

### Жизненный цикл сервиса

- Создание разработческой версии сервиса
- Создание клиентской версии сервиса с кастомизацией настроек для конкретного клиента
- Установка/обновление инстанции сервиса
- Для выполнимых сервисов:
  - Запуск инстанции сервиса
  - Запись журналов работы сервиса в базу данных
  - Запись отчётов о сбоях сервиса в базу данных

### Профили сервисов

Профилями называются именованные группы сервисов. 
Профили используются для обозначения распределяемых групп серисов.

### Роль сервиса

При запуске сервис может выполнять одну из отведённых ролей. 
Роль может указываться в параметрах запуска или в файле конфигурации.

## Версии сервисов

При создании сервиса создаётся архив установочных файлов и метаниформация об этом архиве,
помеченные уникальной версией. 

### Версия разработчика

Версия сервиса от разработчика имеет формат _distribution-build_:
- _distribution_ - имя сервера дистрибуции, на котором создана версия.
- _build_ - номер сборки из чисел, разделённых точками, например *4.21.2*.

Таким образом, для сервера дистрибуции _jetto_ и сборки _3.5.1_, 
будет версия _jetto-3.5.1_.

### Клиентская версия

Из версии разработчика создаётся клиентская версия на том сервере дистрибуции, 
где она будет использоваться. 
Клиентская версия содержит кастомизацию версии разработчика под конкретного клиента.
Она может уточнять конкретные настройки, задавать ключи, сертификаты, и т.д.

Начальная клиентская версия имеет то же название, что и версия разработчика, с которой она была создана.
Если настройки клиента поменялись, клиентская версия пересоздаётся заново. 
Новая версия будет иметь окончание ._N, где N - номер генерации клиентской версии.
Например, созданная с версии разработчика _jetto-3.5.1_, клиентская версия будет называться _jetto-3.5.1_, 
следующие сборки будут называться _jetto-3.5.1_1_, _jetto-3.5.1_2_ и т.д.

### Желательные версии (desired versions)

Сервер дистрибуции хранит некоторое количество последних сгенерированных версий сервиса.
Для того чтобы указать, какую именно версию использовать в текущий момент, предназначен список 
желательных версий в формате _сервис-версия_.

Есть список желательных версий разработчика и клиентских версий.

Изменение желаемых версий происходит всегда целым списком, поскольку версии сервисов зависят друг от друга.

При генерации новой версии, по умолчанию, номер новой версии становится желательным для данного сервиса.
Номер желательной версии можно изменить вручную. 

# Настройки сервисов

<a name="update_json"></a>
## Настройки обновления и запуска сервисов

В главном репозитории разработки сервиса создаётся файл _update.json_,
описывающий правила сборки, установки и запуска.

Формат файла:

- _update[]_ - описания сервисов
  - _service_ : имя сервиса
  - _build_ - объект, правила сборки версии сервиса
    - `buildCommands[]` - команды сборки версии
      - _command_ : команда сборки
      - `args[]` - параметры сборки
      - `env[]` - окружение запуска команды
        - _'имя'_ : значение
      - `directory` : каталог для выполнения, если не указано, текущий
      - `exitCode:number` : код возврата
      - `outputMatch` : соответствие вывода в stderr и stdout, регулярное выражение
    - _copyFiles[]_ - каталоги файлов для копирования в сборку
      - _sourceFile_ : исходный файл в репозитории сервиса
      - _destinationFile_ : файл в образе версии
      - _except[]_ - массив исключений файлов для копирования в сборку
      - `settings[]` - объект, значения макросов в исходных файлах. 
                       При копировании в сборку происходит замена макроса на значение.
        - _'имя макроса'_ : значение макроса
    - _install_
      - `installCommands` : команды установки версии, как в _buildCommands_
      - `postInstallCommands` : команды после установки версии, как в _buildCommands_
      - `runService` - правила запуска сервиса
        - _command_ : команда запуска
        - `args[]` - аргументы запуска
        - `writeLogs` - запись журналов сервиса на локальный диск
          - _directory_ : каталог для записи журналов
          - _filePrefix_ : начало имени файла журнала, полное имя _<filePrefix>.<number>_
          - _maxFileSizeMB_ : максимальный размер файла журнала
          - _maxFilesCount_ : максимальное количество файлов журналов
        - `uploadLogs:boolean` - выгрузка журналов сервиса на сервер update
        - `faultFilesMatch` - регулярное выражение для поиска файлов с информацией о падении
          при неожиданном завершении сервиса. Файлы включаются в отчёт о сбое.
        - `restartOnFault:boolean` - перезапускать сервис после сбоя
        - `restartConditions` - условия для принудительного завершения сервиса
          - `maxMemoryMB:number` : сервис использовал более указанного количества мегабайт памяти
          - `maxCpu` - сервис использовал больше ресурсов CPU, чем указано
            - _percents:number_ : проценты потребления CPU
            - _durationSec:number_ : в течение указанного интервала времени
          - `makeCore:boolean` : для Unix-подобных систем, завершение сервиса сигналом SIGQUIT,
            для образования _core dump_
          - `checkTimeoutMs:number` : интервал проверки условий

В строковых значениях настроек могут присутствовать макро:
- _%%version%%_ - Версия разработчика
- _%%role%%_ - Роль сервиса. Может указываться в параметрах команд _installCommands_, 
               _postInstallCommands_ и _runService_.

При генерации версии разработчика секция _install_ из файла _update.json_ записывается в файл _install.json_
корневого каталога образа версии.

## Настройки работы сервиса от разработчика

Общие настройки работы сервиса, которые определяет разработчик, 
находятся в файлах исходных кодов и определяются конкретным приложением.
В общих настройках могут указываться значения по-умолчанию, либо макросы `%%name%%`, 
либо не указываться ничего.
Общие настройки попадают в образ версии разработчика.

<a name="settings_customization"></a>
## Кастомизация настроек для клиента

При генерации клиентской версии может производиться определение, дополнение и переопределение настроек от разработчика.
Для этого создаётся каталог с дополнительными настройками, с той же структурой, что и каталог образа версии.

Дополнение общих настроек дополнительными происходит по следующим правилам:
- Если требуется дополнить настройки файла с расширением _.conf_ (формат typesafe), _.json_ или _.properties_,
создаётся файл с тем же именем и путём, что и этот файл. В дополнительном файле дополняются или переопределяются 
секции настроек. Для содержимого файлов будет произведено автоматическое слияние (merge).
- Если нужно определить значения макросов `%%name%%` в файле настроек, создаётся файл с таким же именем и расширением
_.defines_, в который записываются значения для макроопределений в формате `name=value`.
- Для одного конфигурационного файла может быть создано несколько дополнительных файлов с 
добавлением индекса к имени _.<index>_. Файлы применяются последовательно, согласно индексу. 
Это позволяет менять конфигурацию клиента из разных источников.
- Если требуется просто добавить файл с настройками, создаётся дополнительный файл с уникальным именем.

Файл _install.json_ может дополняться для клиента по тем же правилам.  

# Сервисы vUpdate

vUpdate сам состоит из сервисов. Таким образом, vUpdate содаёт версии самого себя и обновляет сам себя.

Сервисы vUpdate:
- scripts - Скрипты (Shell, YAML)
- distribution - Сервер дистрибуции
  - Backend
    - Distribution Web Server (платформа [Scala Akka HTTP](https://doc.akka.io/docs/akka-http/current/index.html))
      - Поддерживает запросы GraphQL (платформа [Sangria GraphQL](https://github.com/sangria-graphql/sangria))
    - База данных [MongoDB](https://github.com/mongodb/mongo)
  - Frontend 
    - Distribution Dashboard (платформа [React Js](https://reactjs.org)
- builder - Генератор версий (Scala command line application)
- updater - Установщик инстанции сервисов (Scala command line application)

## Scripts

Производят начальную установку и обновление сервисов.

- _.update.sh_ - базовый скрипт, обновляет сами скрипты, обновляет, запускает сервис
  - _distribution_ - скрипты поддержки сервера дистрибуции
    - _.create_distribution_service.sh_ - устанавливает сервер дистрибуции как сервис операционной системы, 
                                          в настоящее время поддерживается только Linux systemd. 
    - _.make_distribution_config.sh_ - создание начального файла конфигурации, используется _builder_
    -                                  при создании сервера дистрибуции
    - _distribution.sh_ - запуск сервера дистрибуции
  - _builder_ - скрипты поддержки _builder_
    - _builder.sh_ - запускает _builder_
  - _updater_ - скрипты поддержки _updater_
    - _.updater_setup.sh_ - установка _updater_
      - записывает файл конфигурации _updater_
      - устанавливает _updater_ как сервис операционнй системы,
        в настоящее время поддерживается только Linux systemd.
    - _instance.yaml_ - начальный скрипт запуска на Azure 
    - _updater.sh_ - запускает _updater_

## Distribution Server

Ключевым компонентом vUpdate является сервер дистрибуции, с управлением через Distribution Dashboard.
На сервере дистрибуции создаются новые версии сервисов. Для создания новой версии,
_distribution_ запускает _builder_.

<a name="create_distribution_server"></a>
### Создание сервера дистрибуции

Сервер дистрибуции может быть собран и установлен с исходных кодов, или с другого сервера дистрибуции.

#### Сборка и установка сервера дистрибуции с исходных кодов

Установите базу данных MongoDB.

Клонируйте репозиторий vUpdate на сервер дистрибуции:

`git clone git@github.com:jorkey/vUpdate.git`

Выполните команду:

`sbt "project builder; run buildProviderDistribution [cloudProvider=?] distribution=? directory=? port=? title=? mongoDbName=? [serviceOS=?]"`

Вместо `?` подставьте значения:
- _cloudProvider_
  - тип облачного сервиса, если сервер дистрибуции находится в облаке:
      - Azure - единственное на данный момент поддерживаемое облако
- _distribution_
  - уникальное имя сервера дистрибуции, без пробелов
- _directory_
  - каталог для установки
- _port_
  - порт для сервиса http (сервис https можно определить позднее в настройках)
- _title_
  - короткое описание сервера дистрибуции
- _mongoDbName_
  - имя базы данных MongoDB
- _serviceOS_
  - в настоящее время только для установки на Linux. 
  - _true_, если сервер дистрибуции устанавливается как сервис systemd Linux. 

После завершения команды должен запуститься процесс сервера дострибуции.

#### Установка сервера дистрибуции с другого сервера дистрибуции

Заведите учётную запись для нового _customer_ на исходном сервере дистрибуции (см [Учётные записи сервисов](#services_accounts)).

Установите базу данных MongoDB.

Скопируйте во временный каталог из каталога исходного сервера дистрибуции файл _.update.sh_.
Создайте там же скрипт _clone_distribution.sh_:

```
#!/bin/bash -e
set -e

serviceToRun=builder

distributionUrl=?
accessToken=?

. .update.sh "$@" buildConsumerDistribution providerUrl=$distributionUrl [cloudProvider=?] distribution=? directory=? port=? title=? mongoDbName=? provider=? consumerAccessToken=? testConsumerMatch=? [serviceOS=?] 
```

Вместо `?` подставьте значения:
- _distributionUrl_
  - URL исходного сервера дистрибуции
- _accessToken_
  - Access Token сервиса _builder_ исходного сервера дистрибуции
    - Зайдите в _Settings/Accounts/Services_ и нажмите на значок ключа для _builder_.  
- _cloudProvider_
  - тип облачного сервиса, если сервер дистрибуции находится в облаке:
    - Azure - единственное на данный момент поддерживаемое облако
- _distribution_
  - уникальное имя сервера дистрибуции
- _directory_
  - каталог для установки
- _port_
  - порт для сервиса http (сервис https можно определить позднее в настройках)
- _title_
  - короткое описание сервера дистрибуции
- _mongoDbName_
  - имя базы данных MongoDB
- _provider_
  - имя исходного сервера дистрибуции
- _consumerAccessToken_
  - Access Token для учётной записи _consumer_
    - Зайдите в _Settings/Accounts/Distribution Consumers_ и нажмите на значок ключа для соответствующей записи.
- _testConsumerMatch_
  - имя сервера дистрибуции тестовой системы
- _serviceOS_
  - в настоящее время только для установки на Linux.
  - _true_, если сервер дистрибуции устанавливается как сервис systemd Linux.

Выполните скрипт _clone_distribution.sh_. 
После завершения скрипта должен запуститься процесс сервера дистрибуции.

### Настройка сервера дистрибуции

#### Конфигурационный файл 

Файл конфигурации _distribution.json_ находится в рабочем каталоге сервера дистрибуции и имеет следующий формат:

- _distribution_ : уникальное имя сервера дистрибуции
- _title_ : заголовок сервера дистрибуции
- _instance_ : идентификатор инстанции виртуальной мащины 
- _jwtSecret_ : ключ кодирования JWT
- _mongoDb_ - настройка подключения к Mongo DB
  - _connection_ : URL подключения 
  - _name_ : имя базы
- _network_
  - _port:number_ : номер серверного порта http или https
  - `ssl` - настройки для сервиса https
    - _keyStoreFile_ : файл jks с ключами и сертификатами
    - _keyStorePassword_ : пароль доступа к key store
- _builder_ - запуск _builder_
  - _distribution_ : имя сервера дистрибуции, на котором запускать _builder_
- _versions_ - история версий
  - _maxHistorySize:number_ : максимальное количество версий сервиса в истории
- _serviceStates_ - состояние сервисов 
  - _expirationTimeout:FiniteDuration_ : длительность хранения в базе последнего состояния сервиса. 
     Если в течение этого времени состояние не обновляется, инстанция сервиса считается умершей.
- _logs_ - журналы сервисов
  - _expirationTimeout:FiniteDuration_ : длительность хранения в базе записи в журнал
- _faultReports_ - отчёты о сбоях
  - _expirationTimeout:FiniteDuration_ : длительность хранения в базе записи отчёта о сбое
  - _maxReportsCount:number_ : максимальное количество отчётов о сбоях в базе

Структура _FiniteDuration_:
- unit - единицы времени: "SECONDS", "HOURS", "MINUTES", "DAYS"
- length:number - количество единиц
  
### Работа сервера дистрибуции

#### Запросы GraphQL

Сервер дистрибуции принимает запросы GraphQL от пользователей, от других сервисов vUpdate и других серверов дистрибуции.
Запросы GraphQL управляют:
  - учётными записями
  - настройками связи между серверами дистрибуции
  - репозиториями исходных кодов
  - профилями сервисов
  - версиями разработчика
  - желательными версиями разработчика
  - версиями клиента
  - желательными версиями клиента
  - сохранением/поиском состояния сервисов
  - сохранением/поиском журналов сервисов
  - сохранением/поиском отчётов о сбоях

Для создания версий сервер дистрибуции запускает _builder_ локально или на другом сервере дистрибуции.

#### Запись журналов

Журналы сервисов, включая сам _distribution_, записываются в коллекцию MongoDB.
Каждая запись коллекции содержит одну запись журнала и состоит из следующих полей:
- _service_ - название сервиса
- _instance_ - идентификатор инстанции сервера, на котором выполняется сервис 
- _directory_ - текущий каталог процесса
- _process_ - идентификатор процесса
- `task` - если запись получена в процессе выполнения задачи, идентификатор задачи
- payload 
  - _time:Date_ - время и дата создания записи
  - _level_ - уровень отладки
  - _unit_ - функциональный блок
  - _message_ - сообщение журнала
  - _terminationStatus:Boolean_ - статус завершения 
    - если определена _task_ - задачи
    - иначе - процесса  

Схема GraphQL имеет запрос для поиска записей журналов по разным критериям.
Можно также выполнить GraphQL _subscription_ на журнал записей, и тогда новые записи в журнал будут
поступать клиенту GraphQL в реальном времени.

#### Задачи

Действия, асинхронные к запросам GraphQL, оформляются в задачи.
Информация о задачах записывается в коллекцию MongoDB в следующем формате:
- _id_ - идентификатор задачи
- _type_ - тип задачи
- _parameters_ - набор параметров, в формате
  - _name_ - имя параметра
  - _value_ - значение параметра
- _creationTime:Date_ - время и дата создания задачи

Журнал выполнения и статус завершения задачи можно получить из журналов.

<a name="service_state"></a>
#### Обработка состояния сервисов

_Updater_ периодически присылает _distribution_ состояние выполняющихся сервисов. 
Состояние сервисов записываются в коллекцию MongoDB, и на локальный диск.

Формат записи:
- _distribution_ - идентификатор сервера дистрибуции
- _payload:ServiceState_
  - _instance_ - идентификатор инстанции
  - _service_ - название сервиса
  - _directory_ - рабочий каталог сервиса
  - _state:ServiceState_ - состояние сервиса
    - _time_ - время получения состояния
    - `installTime` - время, когда сервис был установлен
    - `startTime` - время запуска сервиса
    - `version` - текущая версия сервиса
    - `updateToVersion` - если сервис в данный момент обновляется, целевая версия
    - `updateError` - ошибка обновления
    - `failuresCount` - количество сбоев сервиса после установки и запуска _updater_
    - `lastExitCode` - последний код завершения

#### Обработка отчётов о сбоях

Отчёты о сбоях сервисов записываются в коллекцию MongoDB, и на локальный диск.

Формат записи:
- _distribution_ - идентификатор сервера дистрибуции 
- _payload_
  - _id_ - идентификатор отчёта о сбое
  - _info_ - последнее состояние сервиса
    - _time_ - время получения состояния
    - _instance_ - идентификатор инстанции сервера
    - _service_ - название сервиса
    - `serviceRole` - роль сервиса
    - _serviceDirectory_ - рабочий каталог сервиса 
    - _serviceState:ServiceState_ - последнее состояние сервиса
    - _logTail:LogLine[]_ - 500 последних записей в журнале
  - _files[]_ - файлы с информацией о сбое

#### Взаимодействие с другими серверами дистрибуции

Сервера дистрибуции могут объединяться в сеть по принципу поставщик/потребитель.

Поставщик предоставляет для потребителя заданные в его _profile_ сервисы.
Если у поставщика появились новые версии, потребитель может скачать их, и установить у себя.
Таким образом компания, разрабатывающая сервисы, может завести учётную запись потребителя
на своём сервере дистрибуции и определить список сервисов, которые она хочет ему отдавать.

Потребитель периодически отправляет поставщику информацию об установленных сервисах поставщика:
- Номера установленных версий
- Состояние инстанций
- Отчёты о сбоях

Поставщик также может выполнять _builder_ для потребителя.
Это необходимо, если на сервере потребителя нет достаточных ресурсов для сборки версии, или поставщик
обладает необходимым набором системных библиотек.

Возможно автоматическое обновление сервисов потребителя при появлении новых версий разработчика у поставщика.
Потребитель периодически проверяет наличие обновлений, и если обновления обнаружены, запускает задачу обновления.

### Обновление сервера дистрибуции

Сервер дистрибуции является сервисом vUpdate, а это означает, что он собирается и обновляется по
общим правилам. Сервер периодически сверяет свою текущую версию с клиентской версией в базе данных,
и если они различаются, перезапускается. Скрипты после завершения сервера дистрибуции устанавливают и запускают 
новую версию.

Завершение сервера дистрибуции также происходит, если обновилась клиентская версия скриптов. В этом случае
скрипты обновляют сами себя и запускают сервер дистрибуции снова.

### История документов в Mongo DB

Все документы vUpdate хранятся в коллекциях специального формата.

У каждого документа, кроме содержательной части, есть дополнительные поля:
- __sequence_ - порядковый номер добавления/модификации документа в коллекции
  - индексировано во возрастанию и убыванию
- __modifyTime_ - время добавления/модификации документа
- __archiveTime_ - время удаления документа
  - индексировано во возрастанию с опцией expire after 7 days

Добавление специальных полей позволяет:
- Сортировать документы в коллекции по порябку их добавления/изменения
- Выяснить дату последней модификации документа
- Хранить историю удалённых документов в течение 7 дней, и при необходимости восстанавливать старые версии

## Builder

Производит:
- Сборку/установку сервера дистрибуции
- Сборку версий разработчика
- Сборку клиентских версий

### Установка и обновление

Builder устанавливается сервером дистрибуции в каталог _<distributionDir>_/builder/_<distribution>_.
Здесь:
- _distributionDir_ - каталог сервера дистрибуции
- _distribution_ - имя сервера дистрибуции, для которого производится сборка

Установка и обновление производится скриптами vUpdate с сервера дистрибуции, для которого производится сборка.

### Установка сервера дистрибуции

Была описана в разделе (см [Создание сервера дистрибуции](#create_distribution_server)).

### Сборка версии разработчика

Сервер дистрибуции выполняет команду:

`builder.sh buildDeveloperVersion service=? version=? sources=? [buildClientVersion=true/false] comment=?`

Здесь:
- _service_ - сервис, для которого изготавливается версия
- _version_ - номер новой версии
- _sources_ - конфигурация исходных репозиториев, Json формата:
  - []
    - _name_ - имя репозитория, является именем каталога, куда копируются исходники
    - _git_
      - _url_ - URL доступа к Git репозиторию
      - _branch_ - branch Git репозитория
      - `cloneSubmodules` - клонировать вместе с submodules
- _buildClientVersion_ - собирать также клиентскую версию
- _comment_ - комментарий к новой версии

Этапы сборки версии:
- В каталог `<builderDir>/developer/services/<service>/source` производится _clone_ или _pull_ репозиториев,
указанных в _sources_. Каждый репозиторий копируется в подкаталог с названием _name_ из конфигурации.
- Сборка версии происходит в первом каталоге, описанном в _sources_. В этом каталоге должен находиться
описанный выше файл _update.json_. Ссылка на другой каталог из другого репозитория должна выглядеть, как `../<name>`.
- При сборке выполняются команды из _build/buildCommands_. 
- Если задан _exitCode_, его значение сравнивается с кодом возврата команды.
- Если задано _outputMatch_, выход команды должен соответствовать этому регулярному выражению.  
- После выполнения команд сборки выполняется копирование файлов из каталога 
`<builderDir>/developer/services/<service>/source` в каталог `<builderDir>/developer/services/<service>/build`
файлов, указанных в _copyFiles_.
- Секция _install_ файла update.json записывается в файл install.json каталога сборки.
- Упаковка в ZIP-файл каталога сборки и закачка образа версии и информации о версии
на сервер дистрибуции.
- После на репозиториях исходных файлов устанавливаются метки с номером сгенерированной версии.
Формат метки: `<service>-<distribution>-<build>`.

### Сборка клиентской версии

Сервер дистрибуции выполняет команду:

`builder.sh buildClientVersion service=? developerVersion=? clientVersion=?`

Здесь:
- _service_ - сервис, для которого изготавливается версия
- _developerVersion_ - версия разработчика, с которой изготавливается клиентская версия
- _clientVersion_ - номер клиентской версии

Этапы сборки версии:
- С сервера дистрибуции скачивается образ версии и распаковывается 
  в каталог `<builderDir>/client/services/<service>/build`.
- Дополнительные настройки из каталога `<builderDir>/install/services/<service>/settings` сливаются
  с настройками версии разработчика (см [Кастомизация настроек для клиента](#settings_customization))
- Файлы из каталога `<builderDir>/install/services/<service>/private` копируются в каталог сборки.
Там хранятся обычно ключи, сертификаты, и всякая другая приватная информация.
- Каталог сборки упаковывается в ZIP-файл каталога сборки, который закачивается на сервер дистрибуции 
  вместе с информацией о версии.

## Updater

Устанавливает, запускает и обновляет инстанции сервисов. 

### Установка updater

Производится скриптом _.updater_setup.sh_. Скрипт создаёт файл конфигурации _updater.json_ и устанавливает
_updater_ как сервис _systemd_.

`.updater_setup.sh <cloudProvider> <name> <services> <distributionUrl> <accessToken> [environment]`

Здесь:
- _cloudProvider_ 
  - Имя облачного сервиса. Единственное поддерживаемое значение на данный момент - _Azure_.
- _name_
  - Часть имени сервиса _systemd_. Полное имя будет таким `update-${name}.service`. 
- _services_
  - Сервисы для запуска, через запятую, к имени сервиса может быть добавлена
    роль, с которой он запускается `-<role>`
- _distributionUrl_
  - URL сервера дистрибуции
- _accessToken_
  - Access token для доступа к серверу дистрибуции

### Файл конфигурации updater.json

- instanceId
  - Идентификатор инстанции виртуальной машины
- distributionUrl
  - URL сервера дистрибуции
- accessToken
  - Access token для доступа к серверу дистрибуции

### Запуск updater

`updater.sh runServices services=<service1>[-<role>][,...]`

Здесь:
- services - сервисы для запуска, как для _.updater_setup.sh_ 

### Работа updater

Для каждого из сервисов, указанных в аргументах, _updater_ выполняет следующее.

#### Установка сервиса

С сервера дистрибуции скачивается желательная клиентская версия для данного сервиса и распаковывается 
в каталог сборки _<service[-role]>/new_.

Из каталога сборки зачитывается файл _install.json_.
В каталоге сборки последовательно выполняются команды _installCommands_ с предварительно выполненными 
расширениями макросов:
- _role_ - роль сервиса
- _version_ - версия разработчика

Каталог сборки _<service[-role]>/new_ переименовывается в каталог рабочий _<service[-role]>/current_.

В рабочем каталоге последовательно выполняются команды _postInstallCommands_ 
с предварительно выполненными расширениями макросов:
- _role_ - роль сервиса
- _version_ - версия разработчика

Команды установки разделены на две группы, чтобы уменьшить время неактивности сервиса при обновлении.
Группа _installCommands_ содержит команды, которые могут выполняться из любого каталога.
Они выполняются до остановки старой версии.
В группе _postInstallCommands_ содержатся команды, которые могут выполняться только из рабочего каталога.

#### Запуск сервиса

В каталоге _<service[-role]>/current_ выполняется команда _runService_ 
с предварительно выполненными расширениями макросов:
- _role_ - роль сервиса
- _version_ - версия разработчика

#### Запись журнала работы

Сервис должен писать журнал работы на стандартный вывод. Формат строки журнала должен быть следующим:
`date level unit message`

Здесь:
_date_ - дата в формате `yyyy-MM-dd HH:mm:ss.SSS`
_level_ - уровень отладки: _TRACE_, _DEBUG_, _INFO_, _WARN_ или _ERROR_
_unit_ - функциональный блок
_message_ - сообщение журнала

Стандартный вывод и вывод ошибок сервиса перехватываются _updater_.

Если в конфигурации определена секция _writeLogs_, полученные строки журнала работы записываются 
в каталог _<service[-role]>/current/<directory>_ по указанным правилам.

Если параметр _uploadLogs_ задан как `true`, строки журнала также отправляются на сервер дистрибуции
в реальном времени.

#### Отправка состояния сервисов

Раз в 10 сек _updater_ отправляет состояние сервисов _ServiceState_ на сервер дистрибуции
(см [Обработка состояния серисов](#service_state)). 

#### Обработка сбоя сервисов

Если сервис неожиданно завершается, формируется отчёт о сбое. 

Регулярное выражение, содержащееся в настройке _faultFilesMatch_, описывает файлы с информацией о сбое,
которые могут образоваться при сбое сервиса. Например, это может быть файл _core dump_, или
файл Java hprof.

Отчёт о сбое записывается в каталог <service[-role]>/faults/<time>.
Кроме того, отчёт о сбое архивируется и отправляется на сервер дистрибуции.

Если значение настройки _restartOnFault_ не определено, или определено как _true_, сервис запускается 
заново.

#### Аварийное прерывание работы сервиса _updater_-ом

Настройка _restartConditions_ описывает условия для принудительного завершения сервиса.

Для ограничения сервиса по количеству использованной памяти указывается параметр _maxMemoryMB_.
При превышении процессом сервиса указанного лимита, сервис принудительно завершается.

Для ограничения сервиса по потреблению CPU указывается параметр _maxCpu_.
Если процесс сервиса потребляет более указанных _percents_ в течение _durationSec_, 
сервис принудительно завершается.

Параметр _makeCore_ указывает на необходимость завершения сервиса сигналом SIGQUIT, 
для образования _core dump_.

Интервал проверки наступления условий прерывания работы сервиса задаётся параметром _checkTimeoutMs_.

#### Обновление версии

Если на сервере дистрибуции меняется желательная версия сервиса:
- Скачивается новая версия
- Выполняются команды из _installCommands_
- Останавливается старая версия
  - Процессу сервиса и его потомкам отправляется сигнал завершения
- Журналы работы сервисов копируются в каталог <service[-role]>/log.history/<version>-<time>.log>
- Выполняются команды из _postInstallCommands_
- Запускается новая версия

### Самообновление

Если на сервере дистрибуции меняется желательная версия _updater_ или _scripts_, _updater_ скачивает
новые версии, но не обновляется сразу, а ждёт, пока не обновится один из сервисов. Это сделано для того,
чтобы не прерывать работу сервисов без необходимости. 

Как только на сервере дистрибуции меняется желательная версия одного из сервисов, _updater_ скачивает обновления
и перезапускается.

# Distribution Dashboard

#### Настройки

Откройте ссылку на сервер дистрибуции в бравсере.
Введите Account Name: admin и Password: admin.
Вы зашли в систему как администратор.

Смените начальный пароль. Для этого войдите в _Settings/Accounts/Users_, выберите пользователя _admin_,
и нажмите "Change Password".

##### Учётные записи

Администрируются в _Settings/Accounts_.

###### Пользователи

Заведите пользователей Dashboard, разработчиков и администраторов.
В информации о версии сервиса будет отображаться имя создавшего его пользователя.

<a name="services_accounts"></a>
###### Сервисы

Учётные записи сервисов vUpdate. После установки сервера дистрибуции уже присутствуют
записи _builder_ и _updater_.
Нажав на иконку с ключом, можно получить Access Key для данного сервиса.
Access Key используется в скриптах запуска и обновления сервисов.

###### Distribution Consumers

Учётные записи других серверов дистрибуции.
В учётной записи, помимо прочего, указываются:
- URL сервера дистрибуции. Его использует _builder_ для удалённой сборки сервиса.
- Services Profile - список разрабатываемых сервисов, которые поставляются данному серверу дистрибуции.

##### Настройка сервисов

###### Development

Описание сервисов для разработки.
Для каждого сервиса указываются репозитории исходных кодов:
- URL - ссылка на Git репозиторий в формате git@_host_:...
- Branch - branch Git репозитория
- Clone Submodules - скачивать репозиторий вместе с подмодулями

###### Service Profiles

Определяются профили сервисов, как подмножества списка сервисов для разработки.
Далее профиль назначается _distribution consumer_ в настройках.
Для обозначения разрабатываемых сервисов, для которых также создаются клиентские версии
на данном сервере дистрибуции, определяется профиль _self_.

##### Providers

Здесь определяются поставщики данного сервера дистрибуции.
Среди прочего, для поставщика определяются:
- _Access Token_ - Ключ доступа при запросах к серверу
- _Test Consumer_ - Имя потребителя, после тестирования которым, сервисы могут быть установлены на данном сервере
- _Upload State Interval_ - Интервал загрузки состояния на поставщика
- _Auto Update_ - При изменении желательных версий на поставщике они автоматически
                  загружаются и устанавливаются на сервер дистрибуции. Интервал для проверки - 10 сек.

## Сборка версии разработчика

Если определены сервисы для разработки, откройте _Build/Developer_.
Покажется таблица сервисов и их версий:
- Service - разрабатываемый сервис
- Last Version, Author, Time, Comment - последняя версия, автор и время генерации сервиса
- Status
  - In Process - версия собирается данный момент
  - Completed - версия собрана

Если в текущий момент не производится сборки версии сервиса, можно запустить задачу
создания новой версии, выбрав запись.
Номер новой версии будет на единицу больше старой, либо его можно назначить вручную.
Если данный сервис присутствует в профиле клиентских сервисов 'self', по-умолчанию
будет предложено создать также клиентскую версию.
После запуска задачи создания новой версии отобразится журнал выполнения задачи
в реальном времени. Можно прервать задачу создания версии.

Если версия создаётся в текущий момент, выбрав запись, можно посмотреть журнал создания в 
реальном времени. Можно прервать задачу создания версии.

## Сборка клиентских версий

Откройте _Build/Client_, если определены сервисы для разработки, иначе _Build_.

Если клиентские версии не создаются в текущий момент, появится диалог запуска сборки.

### С закачкой от поставщика

Если выбран поставщик, покажется таблица сервисов этого поставщика и их версий:
- Service - сервис для установки на клиента
- Provider Desired Version - желаемая версия сервиса у поставщика
- Developer Desired Version - желаемая версия разработчика на сервере дистрибуции
- Client Desired Version - желаемая клиентская версия
- Tested Developer Version - последняя протестированная версия

Уже выбраны для сборки сервисы, для которых нет клиентских версий с желаемой версией от поставщика.
Остальные сервисы выбрать для сборки нельзя.

### Без закачки от поставщика

Если не выбран поставщик, отображаются установленные версии собственной разработки и от поставщиков:
- Service - сервис для установки на клиента
- Developer Desired Version - желаемая версия разработчика на сервере дистрибуции
- Client Desired Version - желаемая клиентская версия

Уже выбраны для сборки сервисы, для которых нет клиентских версий 
с желаемой версией разработчика на сервере дистрибуции.

Можно пометить для сборки и сервисы, для которых уже собраны клиентские версии для данной версии
разработчика. Это имеет смысл, если конфигурация клиента поменялась и нужно пересобрать клиентскую версию.
В этом случае будет сгенерирована клиентская версия с новым номером генерации клиентской версии.

### Мониторинг процесса сборки

После запуска сборки отобразится журнал выполнения задачи в реальном времени. 
При необходимости, можно прервать задачу сборки.

Журнал выполнения задачи также отображается, если при открытии диалога сборки клиентских версий 
уже происходит сборка.  

### Пометка версий как протестированных

Перед установкой сервисов на рабочие сервера, желательно провести комплексное тестирование.
Для того чтобы сервисы могли ставиться на рабочие сервера только после того, как они будут
протестированы, vUpdate имеет механизм пометки списка версий сервисов, как протестированных.

Например, есть некий сервер дистрибуции для рабочих серверов с именем _production_, 
в конфигурации которого задан тестовый сервер дистрибуции _test_. 
Установка новых версий сервисов на сервер _production_ произойдёт только в случае, 
если они были протестированы на _test_, и помечены _test_-ом, как протестированные.

## Желаемые версии

В этом разделе можно редактировать списки желаемых версий разработчика и клиента.
Например, можно откатить неудачно установленное обновление, или несколько последних обновлений.
Это возможно, поскольку сервер дистрибуции хранит несколько последних установленных версий и историю
изменений желаемых версий.

Редактирование производится одним из двух способов.

### Откат до предыдущей редакции списка

Чтобы перейти к более старой редакции, нажмите кнопку 'вниз', для перехода к более новой редакции нажмите 'вверх'.
Время создания списка и автор указываются вверху. Записи в таблице отображают желаемые версии выбранной редакции
в сравнении с последней редакцией:
- стандартным шрифтом отображаются неизменившиеся записи
- жирным шрифтом - у сервиса изменилась желаемая версия
- красным цветом - в этой редакции нет сервиса, который есть в последней редакции
- зелёным цветом - в этой редакции есть сервис, которого нет в последней редакции

Для назначения списка желаемых версий текущим, нажмите _Save_. 

### Назначение версий вручную

Также можно произвольно назначать версии сервисам. Для этого нужно кликнуть по версии сервиса, 
после чего появится список доступных версий в истории.
При изменении версии, запись с сервисом выделяется жирным шрифтом. 

Для назначения отредактированного списка желаемых версий текущим, нажмите _Save_.

## Наблюдение за журналами

Можно просматривать журналы в контексте выполнения задачи или сервиса.

### Наблюдение за журналами задач

Отображается таблица задач в обратном хронологическом порядке:
- Creation Time - время запуска задачи
- ID - идентификатор задачи
- Type - тип задачи 
- Parameters - параметры задачи в формате: _name:value_
- Active - задача выполняется в данное время

При выборе задачи отображаются записи в журнал задачи:
- Time - время записи в журнал
- Level - уровень отладки
- Line - запись в журнал

Возможна выборка по:
- Level - уровню отладки журналов
  - при выбранном уровне отображаются записи этого уровня и выше
- Find Text - образцу текста

При выборе _Follow_ отображается конец журнала, новые записи в журнал отображаются в реальном времени.

### Наблюдение за журналами сервиса

Выполняется поиск журналов выбранного сервиса с опциональной выборкой по:
- Instance - идентификатору инстанции
- Directory - рабочему каталогу сервиса
- Process - номеру процесса сервиса
- Level - уровню отладки журналов
  - при выбранном уровне отображаются записи этого уровня и выше
- From/To - диапазону времени
- Find Text - образцу текста

При выборе _Follow_ отображается конец журнала, новые записи в журнал отображаются в реальном времени.

## Наблюдение за отчётами о сбоях

На сервер дистрибуции поступают отчёты о сбоях его сервисов, и сервисов его потребителей.
По умолчанию отображаются все отчёты в убывающем хронологическом порядке.
Можно сузить диапазон поиска по критериям:
- Distribution - сервер дистрибуции
- Service - имя сервиса
- From/To - диапазон времени

При выборе отчёта отображается информация о сбое и последние записи в журнал работы сервиса.

Возможно скачивание ZIP архива журнала работы в файл. 

## Dashboard

Страница _Dashboard_ предназначена для оперативного контроля работы _vUpdate_.
С её помощью можно увидеть, как живёт _vUpdate_, быстро найти возможные проблемы, 
откатить установленные версии. 

Для отображения информации под разными углами, служат панели. 

### Панель Versions

Предназначена для мониторинга дистрибуции и работы версий сервисов.

Показывается таблица с полями:
- Service - имя сервиса
- Developer Desired Version - версия разработчика
- Client Desired Version - клиентская версия
- Working Version - клиентская версия, выполняющаяся в данный момент
- Directory - рабочий каталог сервиса
- Instances - список идентификаторов инстанций
- Info - состояние сервиса

Таким образом, запись этой таблицы отображает полный путь дистрибуции версии сервиса от 
версии разработчика до версии, работающей на инстанции и её состояния.

Если путь дистрибуции пройден полностью, все три версии будут одинаковыми.
Иначе, отображается красным цветом первая несовпадающая в пути версия.
При выборе _Only Alerts_ отображаются только сервисы с неполным путём дистрибуции.

При выборе потребителя, отображаются версии, установленные на этого потребителя. 

### Панель Last Developer Versions

Отображаются последние выпущенные и выпускаемые версии разработчика.

### Панель Last Client Versions

Отображаются последние выпущенные и выпускаемые версии клиента.


